# BumpSetCut Social Features Spec

## 1. Overview

Add a social layer to BumpSetCut where users can share volleyball rally highlights, browse a TikTok-style feed of community rallies, and interact via likes and comments. The existing local-first workflow (detect, review, trim, export) remains fully functional without an account. Social features are additive and gated behind lazy authentication.

### Goals
- Users can share saved rallies as highlights to the community
- Users can browse, like, and comment on other users' highlights
- The social feed reuses the existing card stack swipe UX
- Local-only features work without sign-in
- MVP ships with minimal backend infrastructure

### Non-Goals (v1)
- Direct messaging between users
- Live streaming
- Team/group management
- Multi-sport support
- Algorithmic "For You" feed (phase 2)

---

## 2. Backend: Supabase

### Why Supabase
- Social data (users, highlights, likes, comments, follows) is inherently relational -- maps directly to PostgreSQL with foreign keys and joins
- Official Swift SDK (`supabase-swift`) via SPM covers auth, real-time subscriptions, storage, RPC, Edge Functions
- Row-Level Security (RLS) for fine-grained per-row access control
- Open source with no vendor lock-in; data exports cleanly as standard Postgres
- ~$195/mo at 10K MAU (Pro plan $25 + storage/egress overages)

### Why Not Firebase
- Firestore (NoSQL) requires painful denormalization for social relationships
- Firebase iOS SDK does NOT support background URLSession uploads (open issue since 2017)
- Higher cost at scale ($200-350/mo at 10K MAU, $2K-5K at 100K MAU)

### Why Not Custom (Vapor)
- 8-16 weeks to MVP vs 3-5 weeks with Supabase
- Requires backend engineering expertise the team may not have
- Lowest cost ($55-80/mo) but highest engineering investment

### Supabase Services Used
| Service | Purpose |
|---------|---------|
| Auth | Apple Sign In, session management, JWT tokens |
| Database | Users, highlights, comments, likes, follows |
| Storage | Avatar images (video hosted on Mux) |
| Real-time | Live comment updates, like count sync |
| Edge Functions | Push notifications via APNs, Mux webhook receiver |

---

## 3. Video Hosting: Mux Basic Quality

### Why Mux
- $0 encoding cost at basic quality tier (dominant cost driver eliminated)
- iOS Upload SDK with client-side resolution adjustment (compress 4K to 1080p before upload)
- Automatic HLS adaptive bitrate streaming, thumbnail generation, per-video analytics
- Direct upload URLs compatible with iOS background URLSession
- Server-side clip/trim operations without re-upload

### Upload Flow
```
iOS App                    Supabase Edge Function         Mux
--------                   ----------------------         ---
1. POST /uploads --------> Create Mux direct upload ----> Returns upload URL + asset ID
2. Background URLSession upload -----------------------> Rally clip uploaded
3. Webhook: asset.ready <------------------------------ Mux notifies
4. Store playback ID in highlights table
5. Feed loads HLS URL from Mux playback ID
```

### iOS Background Upload
- `URLSessionConfiguration.background(withIdentifier:)` -- uploads continue when app is suspended
- File-based uploads only: `uploadTask(with:fromFile:)`
- `isDiscretionary = false` (upload immediately)
- Pre-compress to 1080p before upload for 4K sources
- iOS 17+ resumable upload support

### Thumbnails
- Auto-generated by Mux at configurable timestamps
- URL pattern: `https://image.mux.com/{PLAYBACK_ID}/thumbnail.jpg?time=2`
- Animated GIF previews available via API

### Cost Projection
| Scale | Storage | Delivery | Total |
|-------|---------|----------|-------|
| 100 clips/day | ~$10/mo | usage-based | ~$15/mo |
| 1,000 clips/day | ~$105/mo | usage-based | ~$150/mo |
| 10,000 clips/day | ~$1,050/mo | usage-based | ~$1,200/mo |

---

## 4. Authentication

### Strategy: Lazy Auth
- No sign-in required to use the app (local rally detection, review, export all work offline)
- Auth prompted only when user first: shares a rally, likes/comments, or views Following feed
- Minimizes friction; preserves existing fully-offline workflow

### Provider: Apple Sign In (primary)
- Required by App Store if any third-party sign-in is offered
- Single provider for MVP simplifies implementation
- Google Sign In can be added later via the same `AuthenticationService` interface

### Architecture
```swift
// Core/Auth/AuthenticationService.swift
@MainActor @Observable
class AuthenticationService {
    var currentUser: UserProfile?
    var authState: AuthState  // .unauthenticated, .authenticating, .authenticated, .expired

    func signInWithApple() async throws
    func signOut()
    func refreshToken() async throws
    func deleteAccount() async throws
}

enum AuthState { case unauthenticated, authenticating, authenticated, expired }
```

### Token Storage
- Supabase session tokens stored in Keychain via `KeychainHelper`
- Auto-refresh on app launch
- Silent re-auth when token expires

### Files
```
Core/Auth/
  AuthenticationService.swift   -- @Observable, manages auth state
  AuthToken.swift               -- Codable token model with expiry
  KeychainHelper.swift          -- Keychain read/write
  AppleSignInCoordinator.swift  -- ASAuthorizationController delegate
```

---

## 5. Data Models

### UserProfile
```swift
struct UserProfile: Codable, Identifiable, Hashable {
    let id: String                    // Supabase UUID
    var displayName: String
    var username: String              // Unique handle
    var avatarURL: URL?
    var bio: String?                  // 160 chars max
    var teamName: String?             // Volleyball team/club
    var followersCount: Int
    var followingCount: Int
    var highlightsCount: Int
    let createdAt: Date
}
```

### Highlight (a shared rally clip)
```swift
struct Highlight: Codable, Identifiable, Hashable {
    let id: String
    let authorId: String
    let author: UserProfile?          // Embedded for feed display
    let muxPlaybackId: String         // Mux playback ID for HLS URL
    let thumbnailURL: URL?            // Mux auto-generated
    var caption: String?
    var tags: [String]                // e.g., ["spike", "dig", "beach"]
    let rallyMetadata: RallyHighlightMetadata
    var likesCount: Int
    var commentsCount: Int
    var isLikedByMe: Bool
    let createdAt: Date

    // Links to local data (nil if not from this device)
    var localVideoId: UUID?
    var localRallyIndex: Int?
}

struct RallyHighlightMetadata: Codable, Hashable {
    let duration: Double
    let confidence: Double
    let quality: Double
    let detectionCount: Int
}
```

### Comment
```swift
struct Comment: Codable, Identifiable, Hashable {
    let id: String
    let highlightId: String
    let authorId: String
    let author: UserProfile?
    var text: String                  // 500 chars max
    var likesCount: Int
    var isLikedByMe: Bool
    let createdAt: Date
}
```

### Database Schema (Supabase/PostgreSQL)
```sql
-- users (extends Supabase auth.users)
create table profiles (
    id uuid references auth.users primary key,
    display_name text not null,
    username text unique not null,
    avatar_url text,
    bio text,
    team_name text,
    followers_count int default 0,
    following_count int default 0,
    highlights_count int default 0,
    privacy_level text default 'public',  -- public, followers_only, private
    created_at timestamptz default now()
);

-- highlights
create table highlights (
    id uuid primary key default gen_random_uuid(),
    author_id uuid references profiles(id) on delete cascade,
    mux_playback_id text not null,
    mux_asset_id text not null,
    thumbnail_url text,
    caption text,
    tags text[],
    duration double precision,
    confidence double precision,
    quality double precision,
    detection_count int,
    likes_count int default 0,
    comments_count int default 0,
    privacy_level text default 'public',
    created_at timestamptz default now()
);

-- likes
create table likes (
    user_id uuid references profiles(id) on delete cascade,
    highlight_id uuid references highlights(id) on delete cascade,
    created_at timestamptz default now(),
    primary key (user_id, highlight_id)
);

-- comments
create table comments (
    id uuid primary key default gen_random_uuid(),
    highlight_id uuid references highlights(id) on delete cascade,
    author_id uuid references profiles(id) on delete cascade,
    text text not null,
    likes_count int default 0,
    created_at timestamptz default now()
);

-- follows
create table follows (
    follower_id uuid references profiles(id) on delete cascade,
    following_id uuid references profiles(id) on delete cascade,
    created_at timestamptz default now(),
    primary key (follower_id, following_id)
);
```

---

## 6. iOS Architecture

### Networking Layer
```
Core/Networking/
  APIClient.swift           -- Protocol + Supabase implementation
  APIEndpoint.swift         -- Type-safe endpoint enum
  APIError.swift            -- Typed error cases
  NetworkMonitor.swift      -- NWPathMonitor wrapper
```

```swift
protocol APIClient: Sendable {
    func request<T: Decodable>(_ endpoint: APIEndpoint) async throws -> T
    func upload(fileURL: URL, to endpoint: APIEndpoint, progress: @Sendable (Double) -> Void) async throws -> URL
}
```

Protocol-based so backend can be swapped without touching feature code.

### Local Storage & Caching
```
Core/Storage/
  SocialCache.swift         -- JSON file cache for feed data, profiles (TTL-based)
  OfflineQueue.swift        -- Queues likes/comments/follows when offline
```

- Feed items cached as JSON in `ApplicationSupport/BumpSetCut/SocialCache/`
- Profile data cached per-user-id (TTL: 1 hour)
- Feed cache TTL: 5 minutes
- Offline interactions queued and drained on reconnect (FIFO)
- Optimistic UI: local state updates immediately, syncs in background

### Dependency Injection
Match existing pattern of init-injection + `@Observable`:
```swift
// At HomeView level (root)
@State private var authService = AuthenticationService()
@State private var apiClient: APIClient = SupabaseAPIClient()

// AuthenticationService available app-wide via environment
.environment(authService)
```

### Complete Directory Structure
```
BumpSetCut/
  Core/
    Auth/
      AuthenticationService.swift
      AuthToken.swift
      KeychainHelper.swift
      AppleSignInCoordinator.swift
    Networking/
      APIClient.swift
      APIEndpoint.swift
      APIError.swift
      NetworkMonitor.swift
    Storage/
      MediaStore.swift              (existing)
      MetadataStore.swift           (existing)
      FolderManager.swift           (existing)
      SocialCache.swift             (new)
      OfflineQueue.swift            (new)
  Models/
    Social/
      UserProfile.swift
      Highlight.swift
      Comment.swift
  Features/
    Social/
      Feed/
        SocialFeedView.swift        -- TikTok-style vertical scroll
        SocialFeedViewModel.swift   -- Paginated feed loading
        HighlightCard.swift         -- Single highlight with social overlay
      Profile/
        ProfileView.swift           -- User profile + highlight grid
        ProfileViewModel.swift
        EditProfileView.swift
      Share/
        ShareRallySheet.swift       -- Share local rally as highlight
        ShareRallyViewModel.swift   -- Upload flow with caption/tags
      Comments/
        CommentsSheet.swift         -- Bottom sheet for comments
        CommentsViewModel.swift
      Auth/
        AuthGateView.swift          -- Sign-in prompt
        AuthGateViewModel.swift
```

---

## 7. Social Feed UX

### Feed Tabs
- **Following** (default): Rallies from followed users, reverse-chronological
- **Discover** (phase 2): Trending rallies from all users, engagement-weighted

### Gesture Mapping (reuses existing vocabulary)
| Gesture | Rally Review (existing) | Social Feed (new) |
|---------|------------------------|-------------------|
| Vertical swipe | Next/previous rally | Next/previous highlight |
| Swipe right | Save rally | Like highlight |
| Swipe left | Remove rally | Skip highlight |
| Double tap | Debug overlay | Like highlight (with heart animation) |
| Long press | Enter trim mode | Show comments/share options |
| Pinch zoom | Zoom video | Zoom video |

### Reusable Components
- `CardStackView` / `CardStackViewModel` -- generic card stack already abstracted
- `RallyPlayerCache` -- sliding window of 5 AVPlayers, works with remote URLs
- `RallyThumbnailCache` -- works with remote URLs via AVURLAsset
- `RallyOverviewSheet` thumbnail grid pattern -- reused for profile highlight grid
- Design system tokens (BSCSpacing, BSCRadius, BSCShadow, Color.bscSurfaceGlass)

### Social Overlay (on each HighlightCard)
- Right side vertical stack: like button (heart + count), comment button (bubble + count), share button
- Bottom: author avatar + username + caption text
- Top: following/discover tab switcher

### Comments Bottom Sheet
- `.presentationDetents([.medium, .large])` with drag indicator
- Reverse-chronological, flat (no threading)
- Video continues playing above sheet
- Max 500 chars per comment
- Keyboard pushes sheet up

---

## 8. Sharing Flow

### From Rally Review to Community
1. User saves rallies in existing review flow
2. From RallyOverviewSheet or export menu, tap "Share to Community"
3. `ShareRallySheet` opens: caption field, tag picker, privacy selector
4. On confirm: compress to 1080p if needed, background upload to Mux via direct URL
5. On Mux webhook (asset ready): create highlight row in Supabase
6. Highlight appears in followers' feeds

### Pre-Upload Validation
- Rally must have ProcessingMetadata with valid rallySegments (prevents non-volleyball content)
- Duration must be 3-60 seconds
- Video must have a video track

### Upload Progress
- Reuse/adapt existing `UploadCoordinator` pattern for real network upload
- Show progress in a persistent banner (not blocking)
- Background URLSession continues upload if app is backgrounded

---

## 9. User Profiles

### Fields
- Display name (required, shown in feed)
- Username (required, unique handle for @mentions)
- Avatar (optional, stored in Supabase Storage)
- Bio (optional, 160 chars)
- Team/club name (optional)

### Profile View Layout
- Header: avatar + display name + stats (highlights, followers, following)
- Below header: 3-column grid of rally thumbnails (reuses RallyOverviewSheet pattern)
- Tap thumbnail enters card stack scoped to that user's highlights

### Privacy Levels
- **Public**: Highlights visible to all, profile discoverable
- **Followers Only**: Highlights visible only to approved followers
- **Private**: Highlights visible only to self (effectively local-only sharing)

---

## 10. Privacy & Moderation

### Privacy Defaults
- Profile: public (maximizes discovery)
- Per-highlight: public (with clear confirmation on first post)
- Download by others: off by default
- GPS metadata: automatically stripped from shared videos

### User Controls
- Block: hides all content bidirectionally
- Mute: hides their content from your feed (silent)
- Report: long-press any highlight or comment, select category (inappropriate, spam, not sports, harassment)
- Account deletion: full GDPR-style deletion with 7-day grace period

### Content Moderation
- Pre-screening: reject uploads without ProcessingMetadata (must be a processed volleyball video)
- Rate limiting: flag accounts posting >20 rallies/hour
- Report-based moderation queue for flagged content
- First offense = warning, pattern = temporary restriction

### Settings Integration
Add "Social & Privacy" section to existing SettingsView:
- Account management (profile, sign out, delete account)
- Privacy level (public/followers only/private)
- Download permission toggle
- Blocked/muted users list
- Community guidelines link

---

## 11. Phased Rollout

### Phase 1: MVP (3-5 weeks)
- Supabase project setup (auth, database, storage, RLS policies)
- Mux account + direct upload integration
- Apple Sign In authentication flow
- Core data models (UserProfile, Highlight, Comment)
- Networking layer (APIClient protocol + Supabase implementation)
- Share rally flow (upload to Mux, create highlight in Supabase)
- Social feed (chronological Following feed, reusing CardStackView)
- Like (double-tap + swipe-right) with optimistic UI
- Comments bottom sheet
- Basic profile view (avatar, stats, highlight grid)
- Auth gate (lazy, prompted on first social action)

### Phase 2: Discovery (2-3 weeks)
- Discover tab with engagement-weighted ranking (views + likes + completion rate)
- Search by username, team name, hashtags
- Following suggestions after account creation
- Push notifications for likes and comments (Supabase Edge Function + APNs)
- Offline queue for interactions

### Phase 3: Engagement (2-3 weeks)
- Emoji reactions on comments
- Share to external (iOS share sheet with deep link)
- "For You" algorithmic feed (collaborative filtering, requires data volume)
- Analytics dashboard for creators (views, likes, completion rate per highlight)
- Content reporting and moderation dashboard

---

## 12. Cost Summary

### At Launch (~100 DAU)
| Service | Cost |
|---------|------|
| Supabase Pro | $25/mo |
| Mux (basic quality) | ~$15/mo |
| **Total** | **~$40/mo** |

### At 10K MAU
| Service | Cost |
|---------|------|
| Supabase Pro + overages | ~$195/mo |
| Mux (basic quality) | ~$150/mo |
| **Total** | **~$345/mo** |

### At 100K MAU
| Service | Cost |
|---------|------|
| Supabase Team | ~$800-1,500/mo |
| Mux (basic quality) | ~$1,200/mo |
| **Total** | **~$2,000-2,700/mo** |

---

## 13. Key Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Backend | Supabase | Relational data, Swift SDK, open source, no lock-in |
| Video hosting | Mux Basic | $0 encoding, auto HLS, iOS upload SDK |
| Auth provider | Apple Sign In | App Store requirement, single provider for MVP |
| Auth strategy | Lazy | Local features work offline, social gated behind sign-in |
| Feed algorithm | Chronological (v1) | Simple, trustworthy, avoids cold-start problem |
| Feed UX | Reuse CardStackView | Same swipe vocabulary users already know |
| Comments | Bottom sheet | Video continues playing, standard pattern |
| Offline | Optimistic UI + queue | Interactions feel instant, sync in background |
| Privacy default | Public profiles | Maximizes discovery, clear opt-out available |
| Moderation | Report-based + pre-screening | Rally metadata required prevents non-volleyball content |
