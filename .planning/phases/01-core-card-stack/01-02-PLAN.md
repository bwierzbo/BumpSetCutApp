---
phase: 01-core-card-stack
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - BumpSetCut/Features/CardStack/Components/SwipeableCard.swift
  - BumpSetCut/Features/CardStack/Components/CardActionButtons.swift
autonomous: true

must_haves:
  truths:
    - "User can drag card left/right with finger following touch"
    - "Card springs back to center when drag released below threshold"
    - "Card swipes off screen when drag exceeds threshold"
    - "Card rotates during drag for natural feel"
    - "Heart and trash buttons trigger save/remove actions"
  artifacts:
    - path: "BumpSetCut/Features/CardStack/Components/SwipeableCard.swift"
      provides: "Card view with DragGesture and spring animations"
      min_lines: 80
    - path: "BumpSetCut/Features/CardStack/Components/CardActionButtons.swift"
      provides: "Heart/trash button components"
      min_lines: 40
  key_links:
    - from: "SwipeableCard"
      to: "DragGesture.Value.velocity"
      via: "Built-in velocity tracking in onEnded"
      pattern: "value\\.velocity\\.width"
    - from: "SwipeableCard"
      to: "AnimationTokens.bscSwipe/bscSnappy"
      via: "Consistent spring animations"
      pattern: "\\.bscSwipe|\\.bscSnappy"
    - from: "CardActionButtons"
      to: "Button actions"
      via: "highPriorityGesture to prevent drag interference"
      pattern: "highPriorityGesture"
---

<objective>
Create swipeable card component with gesture handling, spring animations, and action buttons that follows research patterns from AnimationTokens.swift and avoids common pitfalls.

Purpose: Build interactive card UI that feels responsive and natural, using velocity detection and spring physics to match iOS system gestures. This component will wrap any content (placeholder or video) provided by parent.

Output: Reusable SwipeableCard view accepting generic content and action callbacks, with smooth gesture interactions and stable animations.
</objective>

<execution_context>
@/Users/benjaminwierzbanowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benjaminwierzbanowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-card-stack/01-RESEARCH.md
@.planning/phases/01-core-card-stack/01-01-SUMMARY.md

# Animation patterns to use
@BumpSetCut/DesignSystem/Tokens/AnimationTokens.swift

# Reference for gesture patterns (but make generic, not video-specific)
@BumpSetCut/Features/RallyPlayback/RallyPlayerView.swift
</context>

<tasks>

<task type="auto">
  <name>Create SwipeableCard with DragGesture and Velocity Detection</name>
  <files>
    BumpSetCut/Features/CardStack/Components/SwipeableCard.swift
  </files>
  <action>
Create SwipeableCard component following research Pattern 2 (Gesture-Driven Animation with Velocity):

**Component structure:**
- Generic SwiftUI view accepting `content: Content` via @ViewBuilder
- Callbacks: `onSwipeLeft: () -> Void`, `onSwipeRight: () -> Void`
- Binding to `dragOffset: CGSize` from parent view model
- Local `@State private var rotation: Double = 0` for drag rotation

**DragGesture implementation (research lines 311-344):**
```swift
DragGesture()
    .onChanged { value in
        dragOffset = value.translation

        // Calculate rotation during drag (research line 229-232)
        let rotationAmount = Double(value.translation.width) / 20.0
        rotation = max(-15, min(15, rotationAmount))
    }
    .onEnded { value in
        let threshold: CGFloat = 120
        let velocityThreshold: CGFloat = 300

        // Velocity OR distance triggers action (research line 330)
        if abs(value.velocity.width) > velocityThreshold || abs(value.translation.width) > threshold {
            if value.translation.width < -threshold {
                onSwipeLeft()
            } else if value.translation.width > threshold {
                onSwipeRight()
            }
        }

        // Spring back to center (use .bscSnappy from AnimationTokens)
        withAnimation(.bscSnappy) {
            dragOffset = .zero
            rotation = 0
        }
    }
```

**Visual transformations:**
- Apply `.offset(x: dragOffset.width, y: dragOffset.height)`
- Apply `.rotationEffect(.degrees(rotation))`
- Use `.gesture()` modifier (NOT `.simultaneousGesture()` - research Pitfall 2)

**Content placeholder for Phase 1:**
- Accept generic `content` parameter
- Render with rounded corners, shadow (card appearance)
- Background color based on position/state

CRITICAL: Use velocity thresholds of 300-500 pts/sec AND translation threshold of 120pts (research Pitfall 3). Don't use .animation() on container - use withAnimation in gesture handler (research Pitfall 5).
  </action>
  <verify>
```bash
# File exists
ls BumpSetCut/Features/CardStack/Components/SwipeableCard.swift

# Contains DragGesture with velocity check
grep -n "velocity.width" BumpSetCut/Features/CardStack/Components/SwipeableCard.swift

# Uses AnimationTokens
grep -n "bscSnappy\|bscSwipe" BumpSetCut/Features/CardStack/Components/SwipeableCard.swift

# Build succeeds
xcodebuild -project BumpSetCut.xcodeproj -scheme BumpSetCut -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build
```
  </verify>
  <done>
SwipeableCard component exists with DragGesture using value.velocity.width for threshold detection, rotationEffect during drag, and AnimationTokens spring animations. Project builds without errors.
  </done>
</task>

<task type="auto">
  <name>Create CardActionButtons with Gesture Precedence</name>
  <files>
    BumpSetCut/Features/CardStack/Components/CardActionButtons.swift
  </files>
  <action>
Create action buttons following research Pattern (Button Action as Alternative to Swipe, lines 346-373):

**Component structure:**
- Two buttons: trash (left) and heart (right)
- Callbacks: `onRemove: () -> Void`, `onSave: () -> Void`
- HStack with 60pt spacing between buttons
- SF Symbols: `xmark.circle.fill` (trash), `heart.circle.fill` (heart)
- Large touch targets: `.font(.system(size: 56))`
- Colors: `.red` for trash, `.green` for heart

**Gesture precedence (CRITICAL - research Pitfall 2):**
```swift
Button(action: onRemove) {
    Image(systemName: "xmark.circle.fill")
        .font(.system(size: 56))
        .foregroundColor(.red)
}
.highPriorityGesture(TapGesture())  // Prevents parent DragGesture interference
```

Apply `.highPriorityGesture(TapGesture())` to BOTH buttons to prevent drag gesture from consuming tap events.

**Visual feedback:**
- Use `.bscPressEffect(isPressed:)` modifier from AnimationTokens.swift for press animation
- Add `.contentShape(Rectangle())` for full button area tappability

**Layout:**
- HStack centered at bottom of card
- Padding from edges for safe area
- Buttons should work in both portrait and landscape (respond to geometry)

Follow existing button patterns in codebase but make generic (not rally-specific).
  </action>
  <verify>
```bash
# File exists
ls BumpSetCut/Features/CardStack/Components/CardActionButtons.swift

# Contains highPriorityGesture
grep -n "highPriorityGesture" BumpSetCut/Features/CardStack/Components/CardActionButtons.swift

# Uses SF Symbols
grep -n "xmark.circle.fill\|heart.circle.fill" BumpSetCut/Features/CardStack/Components/CardActionButtons.swift

# Build succeeds
xcodebuild -project BumpSetCut.xcodeproj -scheme BumpSetCut -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build
```
  </verify>
  <done>
CardActionButtons component exists with heart/trash SF Symbol buttons, highPriorityGesture on both buttons, and proper color/sizing. Project builds without errors.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Gesture system works correctly:**
   ```bash
   # Velocity detection present
   grep "velocity.width" BumpSetCut/Features/CardStack/Components/SwipeableCard.swift

   # Spring animations from tokens
   grep "bscSnappy\|bscSwipe" BumpSetCut/Features/CardStack/Components/SwipeableCard.swift
   ```

2. **Buttons have gesture precedence:**
   ```bash
   # Both buttons have highPriorityGesture
   test $(grep -c "highPriorityGesture" BumpSetCut/Features/CardStack/Components/CardActionButtons.swift) -eq 2
   ```

3. **Components follow research patterns:**
   - DragGesture uses velocity AND translation thresholds (Pitfall 3)
   - Buttons use highPriorityGesture (Pitfall 2)
   - Animations use existing tokens (Pattern 4)
</verification>

<success_criteria>
- [ ] SwipeableCard accepts generic content via @ViewBuilder
- [ ] DragGesture.onEnded checks both velocity (>300) and translation (>120)
- [ ] Card rotates during drag using calculated rotation (max Â±15 degrees)
- [ ] Card springs back with .bscSnappy when released below threshold
- [ ] CardActionButtons renders heart (green) and trash (red) with large touch targets
- [ ] Both buttons use .highPriorityGesture(TapGesture()) to prevent drag interference
- [ ] Project builds successfully on iOS Simulator
- [ ] No compiler warnings in new files
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-card-stack/01-02-SUMMARY.md`
</output>
