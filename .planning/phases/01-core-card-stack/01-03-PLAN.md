---
phase: 01-core-card-stack
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - BumpSetCut/Features/CardStack/CardStackView.swift
  - BumpSetCut/Features/CardStack/CardStackDemoView.swift
autonomous: false

must_haves:
  truths:
    - "User sees stacked cards with depth effect (scale + offset)"
    - "Top card follows finger during drag"
    - "Background cards remain stable during drag (no jumping)"
    - "Cards maintain correct layering during all animations"
    - "Tapping heart/trash performs action and advances to next card"
  artifacts:
    - path: "BumpSetCut/Features/CardStack/CardStackView.swift"
      provides: "Main card stack container with ZStack and explicit zIndex"
      min_lines: 100
    - path: "BumpSetCut/Features/CardStack/CardStackDemoView.swift"
      provides: "Demo view with placeholder cards for testing"
      min_lines: 40
  key_links:
    - from: "CardStackView"
      to: "viewModel.visibleCardIndices"
      via: "ForEach iteration with stable IDs"
      pattern: "ForEach\\(.*visibleCardIndices"
    - from: "CardStackView"
      to: "zIndexForPosition"
      via: "Explicit zIndex on each card"
      pattern: "\\.zIndex\\(.*zIndexForPosition"
    - from: "CardStackView"
      to: "SwipeableCard + CardActionButtons"
      via: "Component composition in ZStack"
      pattern: "SwipeableCard|CardActionButtons"
---

<objective>
Integrate view model, swipeable card, and action buttons into complete card stack with depth effect, stable layering, and demo view for testing Phase 1 functionality.

Purpose: Wire together all Phase 1 components into working card stack that demonstrates gestures, animations, and state management. This validates the architecture before Phase 2 adds video playback.

Output: CardStackView with placeholder cards showing depth effect, and CardStackDemoView for interactive testing on simulator.
</objective>

<execution_context>
@/Users/benjaminwierzbanowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/benjaminwierzbanowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-card-stack/01-RESEARCH.md
@.planning/phases/01-core-card-stack/01-01-SUMMARY.md
@.planning/phases/01-core-card-stack/01-02-SUMMARY.md

# For depth effect calculations
@BumpSetCut/DesignSystem/Tokens/AnimationTokens.swift

# For explicit zIndex pattern
@BumpSetCut/Features/RallyPlayback/RallyPlayerView.swift
</context>

<tasks>

<task type="auto">
  <name>Create CardStackView with Explicit ZIndex and Depth Effect</name>
  <files>
    BumpSetCut/Features/CardStack/CardStackView.swift
  </files>
  <action>
Create CardStackView following research Pattern 3 (Explicit ZIndex) and Pattern 1 (Identifier-Based Management):

**View structure:**
- `@State private var viewModel: CardStackViewModel`
- `@State private var isPressed = false` for button feedback
- `init(cards: [CardStackItem])` - Initialize view model with cards

**Card stack rendering (CRITICAL - research lines 125-144):**
```swift
ZStack {
    ForEach(viewModel.visibleCardIndices, id: \.self) { cardIndex in
        let position = viewModel.stackPosition(for: cardIndex)
        let card = viewModel.cards[cardIndex]

        SwipeableCard(
            content: {
                // Placeholder content (research Open Question 3)
                placeholderContent(for: card, position: position)
            },
            dragOffset: $viewModel.dragOffset,
            onSwipeLeft: { viewModel.performAction(.remove) },
            onSwipeRight: { viewModel.performAction(.save) }
        )
        .scaleEffect(scaleForPosition(position))
        .offset(y: offsetForPosition(position))
        .opacity(opacityForPosition(position))
        .zIndex(viewModel.zIndexForPosition(position))  // EXPLICIT ZINDEX
    }
}
```

**Depth effect calculations (use AnimationTokens helpers lines 234-247):**
- `scaleForPosition(_ position: Int) -> CGFloat`: 1.0 for current (0), 0.92 for next (1), hide rest
- `offsetForPosition(_ position: Int) -> CGFloat`: 0 for current, 30 for next (peek effect)
- `opacityForPosition(_ position: Int) -> Double`: 1.0 for current, 0.8 for next, 0 for rest

**Placeholder content (research recommendation):**
- Show card index number in large text
- Show "Card X of Y" subtitle
- Background: gradient or solid color based on card index
- Preview button positions (where heart/trash will be)

**Action buttons overlay:**
- Place CardActionButtons at bottom with `.overlay()` modifier
- Only show on current card (position == 0)
- Wire to same callbacks as swipe gestures

**Layout:**
- Use GeometryReader for responsive sizing
- Apply `.edgesIgnoringSafeArea(.all)` for full-screen cards
- Handle safe area insets for button positioning

CRITICAL: Always set explicit `.zIndex()` based on position calculation. Do NOT rely on ZStack's automatic ordering (research Pitfall 1).
  </action>
  <verify>
```bash
# File exists
ls BumpSetCut/Features/CardStack/CardStackView.swift

# Contains ForEach with visibleCardIndices
grep -n "ForEach.*visibleCardIndices" BumpSetCut/Features/CardStack/CardStackView.swift

# Contains explicit zIndex
grep -n "zIndex.*zIndexForPosition" BumpSetCut/Features/CardStack/CardStackView.swift

# Build succeeds
xcodebuild -project BumpSetCut.xcodeproj -scheme BumpSetCut -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build
```
  </verify>
  <done>
CardStackView exists with ForEach over visibleCardIndices, explicit zIndex calls, depth effect (scale/offset/opacity), and CardActionButtons overlay. Project builds without errors.
  </done>
</task>

<task type="auto">
  <name>Create CardStackDemoView with Placeholder Cards</name>
  <files>
    BumpSetCut/Features/CardStack/CardStackDemoView.swift
  </files>
  <action>
Create demo view for testing card stack with sample data:

**Demo data creation:**
- Generate 10 placeholder CardStackItem instances
- Each with unique UUID and placeholder content string
- Content can be simple: "Card 1", "Card 2", etc.

**View structure:**
```swift
struct CardStackDemoView: View {
    var body: some View {
        NavigationStack {
            CardStackView(cards: sampleCards)
                .navigationTitle("Card Stack Demo")
                .toolbar {
                    // Optional: Add reset/debug buttons
                }
        }
    }

    private var sampleCards: [CardStackItem] {
        (1...10).map { index in
            CardStackItem(/* ... */)
        }
    }
}
```

**Preview provider:**
- Add `#Preview` macro for Xcode preview testing
- Show CardStackDemoView

**Optional debug UI:**
- Show current card index at top
- Show saved/removed counts
- Add reset button to restore all cards

This view is for manual testing Phase 1 functionality on simulator before Phase 2 integration.
  </action>
  <verify>
```bash
# File exists
ls BumpSetCut/Features/CardStack/CardStackDemoView.swift

# Contains sample cards
grep -n "sampleCards" BumpSetCut/Features/CardStack/CardStackDemoView.swift

# Build succeeds
xcodebuild -project BumpSetCut.xcodeproj -scheme BumpSetCut -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build
```
  </verify>
  <done>
CardStackDemoView exists with 10 placeholder cards, NavigationStack wrapper, and preview provider. Project builds without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete card stack system with:
- Generic data models (CardStackItem, CardStackAction)
- Observable view model (CardStackViewModel)
- Swipeable card component with gestures
- Action buttons (heart/trash)
- Integrated stack view with depth effect
- Demo view with 10 placeholder cards
  </what-built>

  <how-to-verify>
1. Build and run on iOS Simulator:
   ```bash
   xcodebuild -project BumpSetCut.xcodeproj -scheme BumpSetCut \
     -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build
   ```

2. **If CardStackDemoView is not in app navigation:** Add it to main app navigation temporarily or run in Xcode preview.

3. **Test card stack interactions:**
   - [ ] See stacked cards with depth effect (next card scaled down and offset behind current)
   - [ ] Drag top card left/right - card follows finger smoothly
   - [ ] Drag card and release before threshold - card springs back to center
   - [ ] Drag card past ~1/3 screen width - card swipes off with animation
   - [ ] Card rotates during drag (natural feel)
   - [ ] Background cards stay stable during drag (no jumping or z-index glitches)
   - [ ] Tap heart button - card swipes right, next card advances
   - [ ] Tap trash button - card swipes left, next card advances
   - [ ] Buttons respond immediately without triggering drag

4. **Test requirements coverage:**
   - CARD-01: Stacked layout with depth effect ✓
   - CARD-02: Swipe cards left/right with finger following ✓
   - CARD-03: Spring animations on release ✓
   - CARD-04: Stable layering during animations ✓
   - CARD-05: Heart button alternative to swipe right ✓
   - CARD-06: Trash button alternative to swipe left ✓
   - CARD-08: Visual feedback during drag (rotation) ✓

5. **Check for issues:**
   - Cards jumping or flickering during swipe (zIndex problem)
   - Buttons not responding or triggering drag (gesture precedence issue)
   - Cards not springing back smoothly (animation problem)
   - Next card appearing "on top" when it should be behind (zIndex glitch)
  </how-to-verify>

  <resume-signal>
Type "approved" if all interactions work correctly, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Complete card stack system exists:**
   ```bash
   # All components present
   ls BumpSetCut/Features/CardStack/CardStackView.swift
   ls BumpSetCut/Features/CardStack/CardStackDemoView.swift
   ```

2. **Explicit zIndex prevents glitches:**
   ```bash
   # Every card in ForEach has explicit zIndex
   grep -A 10 "ForEach.*visibleCardIndices" BumpSetCut/Features/CardStack/CardStackView.swift | grep "zIndex"
   ```

3. **Phase 1 requirements validated:**
   - Visual testing confirms all CARD-01 through CARD-08 requirements work
   - No animation glitches or z-index jumping
   - Gestures feel responsive and natural
</verification>

<success_criteria>
- [ ] CardStackView renders cards in ZStack with explicit zIndex
- [ ] Depth effect visible: scale (0.92 for next), offset (30pt for next), opacity (0.8 for next)
- [ ] ForEach uses visibleCardIndices (not direct array iteration)
- [ ] CardActionButtons overlay shows only on current card (position == 0)
- [ ] CardStackDemoView generates 10 sample cards for testing
- [ ] Human verification confirms smooth gestures with no layering glitches
- [ ] Human verification confirms buttons work without triggering drag
- [ ] Project builds successfully on iOS Simulator
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-card-stack/01-03-SUMMARY.md`
</output>
